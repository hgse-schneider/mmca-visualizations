<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>relation</title>
    <!-- 引入依赖的JavaScript库 -->
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts-gl/dist/echarts-gl.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts-stat/dist/ecStat.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/extension/dataTool.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/extension/bmap.min.js"></script>
</head>
<style>
    label {
        font-size: 13px;
    }

    select {
        width: 100px;
        cursor: pointer;
        margin-bottom: 50px;
    }

    #iframe {
        width: 1000px;
        height: 800px;
    }

</style>
<body>
<label>From year</label>
<select id="start_year">
    <option>1999</option>
    <option>2000</option>
    <option>2001</option>
    <option>2002</option>
    <option>2003</option>
    <option>2004</option>
    <option>2005</option>
    <option>2006</option>
    <option>2007</option>
    <option>2008</option>
    <option>2009</option>
    <option>2010</option>
    <option>2011</option>
    <option>2012</option>
    <option>2013</option>
    <option>2014</option>
    <option>2015</option>
    <option>2016</option>
    <option>2017</option>
    <option>2018</option>
    <option>2019</option>
    <option>2020</option>
    <option>2021</option>
    <option>2022</option>
</select>
&nbsp;&nbsp;&nbsp;&nbsp;
<label>to year</label>
<select id="end_year">
    <option>2022</option>
    <option>1999</option>
    <option>2000</option>
    <option>2001</option>
    <option>2002</option>
    <option>2003</option>
    <option>2004</option>
    <option>2005</option>
    <option>2006</option>
    <option>2007</option>
    <option>2008</option>
    <option>2009</option>
    <option>2010</option>
    <option>2011</option>
    <option>2012</option>
    <option>2013</option>
    <option>2014</option>
    <option>2015</option>
    <option>2016</option>
    <option>2017</option>
    <option>2018</option>
    <option>2019</option>
    <option>2020</option>
    <option>2021</option>
</select>
<h2 id="selectedOption">Time period：1999 - 2022</h2>


<!-- 占位符元素 -->
{#    <div id="sankey-chart"></div>#}

<div id="relation-container" style="width: 800px; height: 600px;"></div>

<!-- JavaScript代码 -->
<script>

    // 获取select元素和h2元素
    var selectElement1 = document.getElementById("start_year");
    var selectElement2 = document.getElementById("end_year");
    var h2Element = document.getElementById("selectedOption");

    // 添加事件监听器
    selectElement1.addEventListener("change", updateSelectedOption);
    selectElement2.addEventListener("change", updateSelectedOption);

    // 更新选中的option值
    function updateSelectedOption() {
        // 获取选中的option值
        var selectedValue1 = selectElement1.value;
        var selectedValue2 = selectElement2.value;

        // 设置h2元素的文本内容
        h2Element.textContent = "Time period: " + selectedValue1 + " - " + selectedValue2;
    }


    // 请求数据并渲染Sankey图的函数
    function requestDataAndRenderChart() {
        $.ajax({
            url: "/relation1",
            type: "GET",
            dataType: "json",
            success: function (responseData1) {
                console.log(responseData1)
                console.log(responseData1.nodes)

                // 解析JSON数据并渲染Sankey图
                const nodes = responseData1.nodes;
                const links = responseData1.links;
                var categories = responseData1.categories;

                var chart = echarts.init(document.getElementById("relation-container"));


                var option = {
                    title: {
                        text: 'outcome for sanky',
                        subtext: 'Circular layout',
                        top: 'bottom',
                        left: 'right'
                    },
                    tooltip: {},
                    legend: [
                        {
                            data: categories.map(function (a) {
                                return a.name;
                            })
                        }
                    ],
                    animationDurationUpdate: 1500,
                    animationEasingUpdate: 'quinticInOut',
                    series: [
                        {
                            name: 'outcome for sanky',
                            type: 'graph',
                            layout: 'circular',
                            circular: {
                                rotateLabel: true
                            },
                            data: nodes,
                            links: links,
                            categories: categories,
                            roam: true,
                            label: {
                                position: 'right',
                                formatter: '{b}'
                            },
                            lineStyle: {
                                color: 'source',
                                curveness: 0.3
                            }
                        }
                    ]
                };
                chart.setOption(option);
            }
        })
    }

    // 监听开始年份下拉列表的值变化
    $("#start_year").change(function () {
        // 获取所选的开始年份
        var startYear = $(this).val();

        // 发送开始年份到后端
        sendDataToBackend(startYear, $("#end_year").val());
    });

    // 监听截止年份下拉列表的值变化
    $("#end_year").change(function () {
        // 获取所选的截止年份
        var endYear = $(this).val();

        // 发送截止年份到后端
        sendDataToBackend($("#start_year").val(), endYear);
    });

    // 发送数据到后端的函数
    function sendDataToBackend(startYear, endYear) {
        $.ajax({
            url: "/send_data",
            type: "POST",
            data: {
                start_year: startYear,
                end_year: endYear
            },
            success: function () {
                requestDataAndRenderChart();

                console.log("Data sent to backend successfully.");
            },
            error: function (xhr, status, error) {
                console.error("Error sending data to backend:", error);
            }
        });
    }


    // 初始加载时请求数据并渲染Sankey图
    requestDataAndRenderChart();

</script>
</body>
</html>
